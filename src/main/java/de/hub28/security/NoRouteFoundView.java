package de.hub28.security;

import com.vaadin.flow.router.BeforeEnterEvent;
import com.vaadin.flow.router.ErrorParameter;
import com.vaadin.flow.router.NotFoundException;
import com.vaadin.flow.router.RouteNotFoundError;
import com.vaadin.flow.server.VaadinSession;
import de.hub28.views.about.AboutAdminView;
import jakarta.servlet.http.HttpServletResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;

@Slf4j
public class NoRouteFoundView { //extends RouteNotFoundError {

    //@Override
    public int setErrorParameter(BeforeEnterEvent event, ErrorParameter<NotFoundException> parameter) {

        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();

        if (authentication.getPrincipal() instanceof UserDetails userDetails) {
            if (VaadinSession.getCurrent() != null) {
                GrantedAuthority role = userDetails.getAuthorities().stream().findFirst().get();
                if (role.getAuthority().equals("ROLE_ADMIN")) {
                    event.forwardTo(AboutAdminView.class);
                }
            } else {
                log.debug("### session is null");
            }

        }
        return HttpServletResponse.SC_NOT_FOUND;
    }

}